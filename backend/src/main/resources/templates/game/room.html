<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>{{room.roomTitle}}</title>
	<script src="/webjars/jquery/jquery.min.js"></script>
	<script src="/webjars/sockjs-client/sockjs.min.js"></script>
	<script src="/webjars/stomp-websocket/stomp.min.js"></script>
</head>
<body>
<h1>{{room.roomTitle}}({{room.roomId}})</h1>

<div class="content" data-room-id="{{room.roomId}}">
	<ul class="game_box"></ul>
	<input name="nickname" /> <input name="message" />
	<button class="send">보내기</button>
</div>
<div>
	<button class="start">게임시작</button>
</div>
<div>
	<button class="call">콜</button>
	<input name="raise" />
	<button class="raise">레이즈</button>
	<button class="die">다이</button>
	<button class="allin">올인</button>
</div>
<script>
	$(function() {
		var gameBox = $(".game_box");
		var nicknameInput = $('input[name="nickname"]');
		var messageInput = $('input[name="message"]');
		var raiseInput = $('input[name="raise"]');
		var sendBtn = $(".send");
		var startBtn = $(".start");
		var callBtn = $(".call");
		var raiseBtn = $(".raise");
		var dieBtn = $(".die");
		var allinBtn = $(".allin");
		var roomId = $(".content").data("room-id");
		var sock = new SockJS("/stomp-game");
		var client = Stomp.over(sock);
		client.debug = function(e) {
		};
		console.log(client);

		client.connect({}, function() {
			client.send("/pub/game/message", {}, JSON.stringify({
				roomId : roomId,
				sender : "유동윤",
				type : "ENTER"
			}));

			//공통 메시지를 받으면
			client.subscribe("/sub/game/room" + roomId, function(message) {
				//content에 받은 메시지의 body값을 넣어준다.
				//content.type, content.message등으로 사용 가능
				var content = JSON.parse(message.body);
				console.log(content.type);

				//사람이 들어왔을 때
				if (content.type == "ENTER") {
					//console.log("사람들어왔다" + message.body)
					gameBox.append("<li>" + content.message + "</li>");
				}

				//게임이 시작됐을 때
				if (content.type == "START") {
					//console.log("게임시작하자" + content.message)
					gameBox.append("<li>" + content.message + "</li>");
				}

				//그라운드 카드 받을 때
				if (content.type == "GROUNDCARD") {
					//console.log("그라운드카드 받아라~" + content.message)
					gameBox.append("<li>" + content.message + "</li>");
				}

				//기본 배팅 하자
				if (content.type == "UNITBETTING") {
					gameBox.append("<li>" + content.message + "</li>");
				}

				//카드 받자 player수만큼 요청하자
				if (content.type == "MAKECARDSET") {
					//console.log("개인카드 달라고 요청했음")
					//기본배팅 했으니까 GETCARD 요청
					client.send("/pub/game/message", {}, JSON.stringify({
						roomId : roomId,
						message : "",
						sender : "",
						type : "GETMYCARD"
					}));
				}

				//플레이어가 콜 버튼 눌렀네
				if (content.type == "PLAYERCALL") {
					gameBox.append("<li>" + content.message + "</li>");
				}

				//플레이어가 레이즈 버튼 눌렀네
				if (content.type == "PLAYERRAISE") {
					gameBox.append("<li>" + content.message + "</li>");
				}

				//플레이어가 다이 버튼 눌렀네
				if (content.type == "PLAYERDIE") {
					gameBox.append("<li>" + content.message + "</li>");
				}

				//플레이어가 올인 버튼 눌렀네
				if (content.type == "PLAYERALLIN") {
					gameBox.append("<li>" + content.message + "</li>");
				}

			});

			//개인 메시지를 받으면
			client.subscribe("/user/sub/game/room" + roomId, function(
					message) {
				var content = JSON.parse(message.body);

				//개인 카드 받기
				if (content.type == "GETMYCARD") {
					//무슨 카드를 받았나?
					gameBox.append("<li>" + content.message + "</li>");
				}

				//첫 배팅하기
				if (content.type == "FIRSTBETTING") {
					//이거 받은사람만 콜빼고 배팅버튼 활성화
					gameBox.append("<li>" + content.message + "</li>");
				}

				//나머지 배팅하기
				if (content.type == "BETTING") {
					//이거 받은사람만 배팅버튼 활성화
					gameBox.append("<li>" + content.message + "</li>");
				}

			});

		});
		/*
        client.disconnect({}, function() {
            client.send("/pub/game/message", {}, JSON.stringify({
                roomId : roomId,
                sender : "",
                type : "EXIT"
            }));
        });
        */


		sendBtn.click(function() {
			console.log("보내기 눌렀다.--------")
			var content = messageInput.val();
			var nickname = nicknameInput.val();
			client.send("/pub/game/message", {}, JSON.stringify({
				roomId : roomId,
				message : content,
				sender : nickname
			}));
			messageInput.val("");
		});

		startBtn.click(function() {
			console.log("게임 시작됐다!!")
			//gameBox.append("<li> 게임이 시작되었습니다. </li>");
			client.send("/pub/game/message", {}, JSON.stringify({
				roomId : roomId,
				message : "",
				sender : "",
				type : "START"
			}));
		});

		callBtn.click(function() {
			console.log("콜 버튼이 눌렸다")
			client.send("/pub/game/message", {}, JSON.stringify({
				roomId : roomId,
				message : "",
				sender : "",
				type : "CALL"
			}));
		});

		raiseBtn.click(function() {
			console.log("레이즈 버튼이 눌렸다")
			var raiseCnt = raiseInput.val();
			client.send("/pub/game/message", {}, JSON.stringify({
				roomId : roomId,
				message : "raiseCnt",
				sender : "",
				type : "RAISE"
			}));
		});

	});
</script>
</body>
</html>
